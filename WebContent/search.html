<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Expires" content="-1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>dd tool</title>
	<link href="css/bootstrap.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-table.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-editable.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-select.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-theme.min.css" type="text/css" rel="stylesheet" />
	<link rel="stylesheet" href="css/bootstrap-tagsinput.css">
	<link href="css/mycss.css" type="text/css" rel="stylesheet" />

</head>
<body>

	<div class="container-fluid" style="margin-top: 10px;">

		<div id="divLoading"></div>

    <div class="toolbar form-inline" id="searchToolbar">
      <select class="selectpicker" id="searchSelect" multiple data-actions-box="true" data-live-search="true" title="Choose table(s)...">
      </select>
      <select class="selectpicker" id="searchColumnSelect" multiple data-actions-box="true" data-live-search="true" title="Choose columns()...">
      </select>
      <button type="button" onclick="Filter()" class="btn btn-default" data-toggle="tooltip" title="Filter."><span class="glyphicon glyphicon-filter" aria-hidden="true"></span></button>
			<button type="button" onclick="OpenQueryModal()" class="btn btn-default" data-toggle="tooltip" title="Set SQL queries for labels and description."><span class="glyphicon glyphicon-cog" aria-hidden="true"></span></button>
    </div>


		<table class="table table-striped fontsize" id="searchTable">

		</table>

		<!-- modelList modal -->
		<div class="modal fade" id="queryModal" tabindex="-1" role="dialog" aria-labelledby="queryModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="queryModalLabel">Paste SQL queries for labels and descriptions</h4>
					</div>
					<div class="modal-body">
						<form>
		          <div class="form-group">
		            <label for="tableLabel" class="col-form-label">Table Label</label>
		            <textarea class="form-control" id="tableLabel"></textarea>
		          </div>
							<div class="form-group">
		            <label for="tableDescription" class="col-form-label">Table Description</label>
		            <textarea class="form-control" id="tableDescription"></textarea>
		          </div>
							<div class="form-group">
		            <label for="columnLabel" class="col-form-label">Column Label</label>
		            <textarea class="form-control" id="columnLabel"></textarea>
		          </div>
							<div class="form-group">
		            <label for="columnDescription" class="col-form-label">Column Description</label>
		            <textarea class="form-control" id="columnDescription"></textarea>
		          </div>
        		</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" onclick="GetLabels()"><span class="glyphicon glyphicon-ok aria-hidden="true"></button>
						<button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove aria-hidden="true"></button>
					</div>
				</div>
			</div>
		</div>
		<!-- modelList modal -->


	</div> <!-- container -->



	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/bootstrap-table.min.js"></script>
	<script src="js/bootstrap-editable.js"></script>
	<script src="js/bootstrap-table-editable.js"></script>
	<script src="js/bootstrap-select.min.js"></script>
	<script src="js/bootstrap-list-filter.min.js"></script>
	<script src="js/bootstrap-tagsinput.js"></script>
	<script src="js/bootbox.min.js"></script>
  <script>

    var searchCols = [];
    searchCols.push({field:"table_name", title: "Table Name", sortable: true, searchable: false});
    searchCols.push({field:"table_type", title: "Table Type", sortable: true, searchable: false});
    searchCols.push({field:"table_remarks", title: "Table Remarks", sortable: true, searchable: false});
		searchCols.push({field:"table_description", title: "Table Description", sortable: true, searchable: false});
    searchCols.push({field:"column_name", title: "Column Name", sortable: true, searchable: false});
    searchCols.push({field:"column_type", title: "Column Type", sortable: true, searchable: false});
    searchCols.push({field:"column_remarks", title: "Column Remarks", sortable: true, searchable: false});
		searchCols.push({field:"column_description", title: "Column Description", sortable: true, searchable: false});
		searchCols.push({field:"column_size", title: "Column Size", sortable: true, searchable: false});
		searchCols.push({field:"isNullable", title: "Is Nullable", sortable: true, searchable: false});

    $(document)
    .ready(function() {
      buildTable($('#searchTable'), searchCols);
      ChooseTable($('#searchSelect'));
      ChooseColumn($('#searchColumnSelect'));
      GetSchema($('#searchTable'));
    })
		.ajaxStart(function(){
		    $("div#divLoading").addClass('show');
		})
		.ajaxStop(function(){
		    $("div#divLoading").removeClass('show');
		});

		$(window).load(function(){

  		$('div#divLoading').fadeOut(2000);
			// $("div#divLoading").addClass('show');

		});

    $('#searchSelect').change(function () {
        // var selectedText = $(this).find("option:selected").val();
    		// console.log(selectedText);
        // console.log($('#searchSelect').val());
    });

    $('#searchTable').on('reset-view.bs.table', function(){
    });

		function OpenQueryModal(){
			$('#queryModal').modal('toggle');
			GetLabelsQueries();
		}

		function GetLabelsQueries(){

			$.ajax({
				type: 'POST',
				url: "GetLabelsQueries",
				dataType: 'json',

				success: function(queries) {
					console.log(queries);
					$('#tableLabel').val(queries.tlQuery);
					$('#tableDescription').val(queries.tdQuery);
					$('#columnLabel').val(queries.clQuery);
					$('#columnDescription').val(queries.cdQuery);
				},
				error: function(data) {
					console.log(data);
				}
			});

		}

		function GetLabels(){

			var parms = {};
			parms.tables = $('#searchSelect').val();
			parms.tlQuery = $('#tableLabel').val();
			parms.tdQuery = $('#tableDescription').val();
			parms.clQuery = $('#columnLabel').val();
			parms.cdQuery = $('#columnDescription').val();

			// console.log("parms");
			// console.log(JSON.stringify(parms));

			$.ajax({
				type: 'POST',
				url: "GetLabels",
				dataType: 'json',
				data: JSON.stringify(parms),

				success: function(labels) {
					console.log(labels);

					var datas = $('#searchTable').bootstrapTable("getData");

					$.each(datas, function(i, object){
						if(labels[object.table_name]){
							object.table_remarks = labels[object.table_name].table_remarks;
							object.table_description = labels[object.table_name].table_description;
							if(labels[object.table_name].columns[object.column_name]){
								object.column_remarks = labels[object.table_name].columns[object.column_name].column_remarks;
								object.column_description = labels[object.table_name].columns[object.column_name].column_description;
							}
						}
					})

					$('#searchTable').bootstrapTable("load", datas);
					localStorage.setItem('labels', JSON.stringify(labels));

					var tables = JSON.parse(localStorage.getItem('tables'));
					if(tables){
						console.log("tables");
						console.log(tables);
						$.each(tables, function(i, table){
							table.remarks = labels[table.name].table_remarks;
							table.description = labels[table.name].table_description;
						})
						localStorage.setItem('tables', JSON.stringify(tables));
						ChooseTable($('#searchSelect'));
					}

				},
				error: function(data) {
					console.log(data);
				}
			});

			$('#queryModal').modal('toggle');

		}

    function Filter(){
      var selection = $('#searchSelect').val();
      console.log(selection);

			var datas = $('#searchTable').bootstrapTable("getData");

      $.each(datas, function(i, row){
        row.filtered = true;
        $.each(selection, function(j, table){
          if(row.table_name.match(table)){
            row.filtered = false;
            return false;
          }
        });
      });

      selection = $('#searchColumnSelect').val();
      console.log(selection);
      var cols = $('#searchTable').bootstrapTable('getOptions').columns[0];
      console.log(cols);

      $.each(cols, function(i, col){
        col.searchable = false;
        $.each(selection, function(j, colName){
          if(col.field.match(colName)){
            console.log(col.title + ' searchable');
            col.searchable = true;
            return false;
          }
        });
      });

      $('#searchTable').bootstrapTable('destroy');
      buildTable($('#searchTable'), cols);
      $('#searchTable').bootstrapTable('load', datas);

      $('#searchTable').bootstrapTable("filterBy", {filtered: [false]});

    }

    function GetSchema(table) {

        $.ajax({
            type: 'POST',
            url: "GetSchema",
            dataType: 'json',

            success: function(data) {
                console.log(data);

								var schema = [];
								var labels = {};

								$.each(data, function(i, table){
									labels[table.table_name] = {};
									labels[table.table_name].table_name = table.table_name;
									labels[table.table_name].table_remarks = table.table_remarks;
									labels[table.table_name].table_description = table.table_description;
									labels[table.table_name].columns = {};
									$.each(table.columns, function(j, column){
										labels[table.table_name].columns[column.column_name] = {};
										labels[table.table_name].columns[column.column_name].column_remarks = column.column_remarks;
										labels[table.table_name].columns[column.column_name].column_description = column.column_description;
										var field = {};
										field.table_name = table.table_name;
										field.table_type = table.table_type;
										field.table_remarks = table.table_remarks;
										field.table_description = table.table_description;
										field.column_name = column.column_name;
										field.column_type = column.column_type;
										field.column_remarks = column.column_remarks;
										field.column_description = column.column_description;
										field.column_size = column.column_size;
										field.isNullable = column.isNullable;
										field.filtered = column.filtered;
										schema.push(field);
									})
								});

								console.log(labels);
								localStorage.setItem('labels', JSON.stringify(labels));
								console.log(schema);
								table.bootstrapTable("load", schema);

    			  },
            error: function(data) {
                console.log(data);
            }
    		});

    }

    function buildTable($el, cols) {

        $el.bootstrapTable({
            columns: cols,
            // url: url,
            // data: data,
            toolbar: $('#searchToolbar'),
            search: true,
						searchOnEnterKey: true,
    				showRefresh: false,
    				showColumns: true,
    				showToggle: false,
    				pagination: true,
						pageSize: 25,
    				showPaginationSwitch: true,
						paginationVAlign: "both",
            detailView: false
        })

        var $tableHeaders = $el.find('thead > tr > th');
        console.log('$tableHeaders');
        console.log($tableHeaders.eq(3));
        var cols = $el.bootstrapTable('getOptions').columns[0];
        console.log(cols);
        $.each(cols, function(i, col){
          if(col.title.match('Table Type')){
            col.searchable = false;
          };
        });
        console.log(cols);
    }

    function ChooseColumn(table){
      table.empty();

      $.each($('#searchTable').bootstrapTable('getOptions').columns[0], function(i, obj){
        var option = '<option class="fontsize" value=' + obj.field + '>' + obj.title + '</option>';
        table.append(option);
      });
      table.selectpicker('refresh');
    }

    function ChooseTable(table) {

			table.empty();

			var tables;

			if(localStorage.getItem('tables')){
				tables = JSON.parse(localStorage.getItem('tables'));
			}
			else {
					$.ajax({
					type: 'POST',
					url: "Scan",
					dataType: 'json',
					async: false,
					success: function(data) {
						tables = data;
					}
				});
			}

			console.log(tables);

			tables.sort(function(a, b) {
				// return parseInt(b.FKCount) - parseInt(a.FKCount);
				return parseInt(b.FKSeqCount) - parseInt(a.FKSeqCount);
			});
			$.each(tables, function(i, obj){
				//console.log(obj.name);
				var option = '<option class="fontsize" value=' + obj.name + '>' + obj.name + ' (' + obj.remarks + ') (' + obj.FKCount + ') (' + obj.FKSeqCount + ')'
				 + ' (' + obj.PKCount + ') (' + obj.PKSeqCount + ') (' + obj.RecCount + ')' + '</option>';
				table.append(option);
				// $('#modPKTables').append(option);
				// table.append('<option class="fontsize" value=' + obj.name + '>' + obj.name + '</option>');
			});
			table.selectpicker('refresh');
			// $('#modPKTables').selectpicker('refresh');
			localStorage.setItem('tables', JSON.stringify(tables));

    }


  </script>

</body>
</html>
