<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Expires" content="-1">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>dd tool</title>
	<link href="css/bootstrap.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-table.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-editable.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-select.min.css" type="text/css" rel="stylesheet" />
	<link href="css/bootstrap-theme.min.css" type="text/css" rel="stylesheet" />
	<link rel="stylesheet" href="css/bootstrap-tagsinput.css">
	<link href="css/mycss.css" type="text/css" rel="stylesheet" />

</head>
<body>

	<div class="container-fluid" style="margin-top: 10px;">

		<div id="divLoading"></div>

    <div class="toolbar form-inline" id="searchToolbar">
      <select class="selectpicker" id="searchSelect" multiple data-actions-box="true" data-live-search="true" title="Choose table(s)...">
      </select>
      <select class="selectpicker" id="searchColumnSelect" multiple data-actions-box="true" data-live-search="true" title="Choose columns()...">
      </select>
      <button type="button" onclick="Filter()" class="btn btn-default" data-toggle="tooltip" title="Filter."><span class="glyphicon glyphicon-filter" aria-hidden="true"></span></button>
    </div>


		<table class="table table-striped fontsize" id="searchTable">

		</table>

	</div> <!-- container -->



	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/bootstrap-table.min.js"></script>
	<script src="js/bootstrap-editable.js"></script>
	<script src="js/bootstrap-table-editable.js"></script>
	<script src="js/bootstrap-select.min.js"></script>
	<script src="js/bootstrap-list-filter.min.js"></script>
	<script src="js/bootstrap-tagsinput.js"></script>
	<script src="js/bootbox.min.js"></script>
  <script>

    var schema = [];

    var searchCols = [];
    searchCols.push({field:"tabName", title: "Table Name", sortable: true, searchable: false});
    searchCols.push({field:"tabType", title: "Table Type", sortable: true, searchable: false});
    searchCols.push({field:"tabRemarks", title: "Table Remarks", sortable: true, searchable: false});
    searchCols.push({field:"colName", title: "Column Name", sortable: true, searchable: false});
    searchCols.push({field:"colType", title: "Column Type", sortable: true, searchable: false});
    searchCols.push({field:"colRemarks", title: "Column Remarks", sortable: true, searchable: false});
		searchCols.push({field:"colSize", title: "Column Size", sortable: true, searchable: false});
		searchCols.push({field:"isNullable", title: "Is Nullable", sortable: true, searchable: false});

    $(document)
    .ready(function() {
      buildTable($('#searchTable'), searchCols);
      ChooseTable($('#searchSelect'));
      ChooseColumn($('#searchColumnSelect'));
      GetSchema($('#searchTable'));
    })
		.ajaxStart(function(){
		    $("div#divLoading").addClass('show');
		})
		.ajaxStop(function(){
		    $("div#divLoading").removeClass('show');
		});

    $('#searchSelect').change(function () {
        // var selectedText = $(this).find("option:selected").val();
    		// console.log(selectedText);
        // console.log($('#searchSelect').val());
    });

    $('#searchTable').on('reset-view.bs.table', function(){
    });

    function Filter(){
      var selection = $('#searchSelect').val();
      console.log(selection);

      $.each(schema, function(i, row){
        row.filtered = true;
        $.each(selection, function(j, table){
          if(row.tabName.match(table)){
            row.filtered = false;
            return false;
          }
        });
      });

      selection = $('#searchColumnSelect').val();
      console.log(selection);
      var cols = $('#searchTable').bootstrapTable('getOptions').columns[0];
      console.log(cols);

      $.each(cols, function(i, col){
        col.searchable = false;
        $.each(selection, function(j, colName){
          if(col.field.match(colName)){
            console.log(col.title + ' searchable');
            col.searchable = true;
            return false;
          }
        });
      });

      $('#searchTable').bootstrapTable('destroy');
      buildTable($('#searchTable'), cols);
      $('#searchTable').bootstrapTable('load', schema);

      $('#searchTable').bootstrapTable("filterBy", {filtered: [false]});

    }

    function GetSchema(table) {

        $.ajax({
            type: 'POST',
            url: "GetSchema",
            dataType: 'json',

            success: function(data) {
                // console.log(data);
                table.bootstrapTable("load", data);
                schema = data;
								console.log(schema);
								localStorage.setItem('schema', JSON.stringify(schema));
								console.log("localStorage");
								console.log(localStorage.getItem('schema'));
    			  },
            error: function(data) {
                console.log(data);
            }
    		});

    }

    function buildTable($el, cols) {

        $el.bootstrapTable({
            columns: cols,
            // url: url,
            // data: data,
            toolbar: $('#searchToolbar'),
            search: true,
    				showRefresh: false,
    				showColumns: true,
    				showToggle: false,
    				pagination: false,
    				showPaginationSwitch: false,
            detailView: false
        })

        var $tableHeaders = $el.find('thead > tr > th');
        console.log('$tableHeaders');
        console.log($tableHeaders.eq(3));
        var cols = $el.bootstrapTable('getOptions').columns[0];
        console.log(cols);
        $.each(cols, function(i, col){
          if(col.title.match('Table Type')){
            col.searchable = false;
          };
        });
        console.log(cols);
    }

    function ChooseColumn(table){
      table.empty();

      $.each($('#searchTable').bootstrapTable('getOptions').columns[0], function(i, obj){
        var option = '<option class="fontsize" value=' + obj.field + '>' + obj.title + '</option>';
        table.append(option);
      });
      table.selectpicker('refresh');
    }

    function ChooseTable(table) {

    	table.empty();

      $.ajax({
          type: 'POST',
          url: "Scan",
          dataType: 'json',

          success: function(data) {
              console.log(data);
              data.sort(function(a, b) {
                // return parseInt(b.FKCount) - parseInt(a.FKCount);
                return parseInt(b.FKSeqCount) - parseInt(a.FKSeqCount);
              });
              tables = data;
              $.each(data, function(i, obj){
  							//console.log(obj.name);
                var option = '<option class="fontsize" value=' + obj.name + '>' + obj.name + ' (' + obj.remarks + ') (' + obj.FKCount + ') (' + obj.FKSeqCount + ')'
                 + ' (' + obj.PKCount + ') (' + obj.PKSeqCount + ') (' + obj.RecCount + ')' + '</option>';
  							table.append(option);
                // $('#modPKTables').append(option);
                // table.append('<option class="fontsize" value=' + obj.name + '>' + obj.name + '</option>');
  			      });
  			      table.selectpicker('refresh');
              // $('#modPKTables').selectpicker('refresh');
  			  },
          error: function(data) {
              console.log(data);
          }
  		});

    }


  </script>

</body>
</html>
